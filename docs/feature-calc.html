---

title: Title

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_feature-calc.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Feature-calculation">Feature calculation<a class="anchor-link" href="#Feature-calculation"> </a></h3><blockquote><p>This module calculates features/aggregations that could be useful to detect fraudulent transactions. Results are saved into 2 parquet datasets for features email and customer_id features. These features are calculated:Email aggregations: * "num_customer_id_by_email": number of previously known different customer_ids for a given email, up to 10</p>
<ul>
<li>"same_customer_id_by_email": 1 if order contains the same customer_id as the last order from this email</li>
<li>"known_customer_id_by_email": 1 if the customer_id has been seen before with the email</li>
<li>"order_amount_mean_by_email": mean of the last 10 order amounts on this email</li>
<li>"order_amount_std_by_email": std</li>
<li>"order_amount_min_by_email": min</li>
<li>"order_amount_max_by_email": max</li>
<li>"order_amount_sum_by_email": sum</li>
</ul>
</blockquote>
<p>Customer_id aggregations:</p>
<ul>
<li>"num_email_by_customer_id": number of previosuly seen different emails on the order customer_id, up to 10</li>
<li>"num_ip_addr_by_customer_id": number of previously seen different IP addresses for the order customer_id, up to 10</li>
<li>"same_email_by_customer_id": 1 is the email is the same as latest order for this customer_id</li>
<li>"same_ip_addr_by_customer_id": 1 is the ip address is the same</li>
<li>"known_email_by_customer_id": 1 if the email was seen before with this customer_id</li>
<li>"known_ip_addr_by_customer_id": 1 if the IP address was seen befor with this customer_id</li>
<li>"order_amount_mean_by_customer_id": mean of the last 10 order amount on this customer_id</li>
<li>"order_amount_std_by_customer_id": std</li>
<li>"order_amount_min_by_customer_id": min</li>
<li>"order_amount_max_by_customer_id": max</li>
<li>"order_amount_sum_by_customer_id": sum</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="calculate" class="doc_header"><code>calculate</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/feature_calc.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>calculate</code>(<strong><code>df</code></strong>, <strong><code>count_cols</code></strong>, <strong><code>stat_cols</code></strong>, <strong><code>by</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="count_distinct_values" class="doc_header"><code>count_distinct_values</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/feature_calc.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>count_distinct_values</code>(<strong><code>df</code></strong>, <strong><code>cols</code></strong>, <strong><code>by</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="num_stats" class="doc_header"><code>num_stats</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/feature_calc.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>num_stats</code>(<strong><code>df</code></strong>, <strong><code>cols</code></strong>, <strong><code>by</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run" class="doc_header"><code>run</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/feature_calc.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run</code>(<strong><code>job</code></strong>:<a href="/fraud_poc/jobs#PreprocessingJob"><code>PreprocessingJob</code></a>, <strong><code>context</code></strong>:<code>EventContext</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-from-notebook">Test from notebook<a class="anchor-link" href="#Test-from-notebook"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">hopeit.testing.apps</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">execute_event</span>

<span class="n">app_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;config/training-pipeline.json&#39;</span><span class="p">)</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">PreprocessingJob</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;./data/raw&#39;</span><span class="p">,</span> <span class="n">partitioned</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="s1">&#39;./data/partitioned/customer_id/&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;./data/partitioned/email&#39;</span>
<span class="p">})</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">execute_event</span><span class="p">(</span><span class="n">app_config</span><span class="p">,</span> <span class="s1">&#39;data.feature-calc&#39;</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
<span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-07-08 11:12:58,114 | INFO | fraud-poc 0.0.1-training data.feature-calc leo-legion 35566 | Calculating features on customer_id... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T11:12:57.415253+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
2020-07-08 11:15:10,771 | INFO | fraud-poc 0.0.1-training data.feature-calc leo-legion 35566 | Saved ./data/features/customer_id/. | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T11:12:57.415253+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
2020-07-08 11:15:10,772 | INFO | fraud-poc 0.0.1-training data.feature-calc leo-legion 35566 | Calculating features on email... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T11:12:57.415253+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
2020-07-08 11:16:38,234 | INFO | fraud-poc 0.0.1-training data.feature-calc leo-legion 35566 | Saved ./data/features/email/. | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T11:12:57.415253+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FeatureCalcJob(sources={&#39;customer_id&#39;: &#39;./data/partitioned/customer_id/&#39;, &#39;email&#39;: &#39;./data/partitioned/email&#39;}, features={&#39;customer_id&#39;: &#39;./data/features/customer_id/&#39;, &#39;email&#39;: &#39;./data/features/email/&#39;})</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order_id</th>
      <th>order_date</th>
      <th>email</th>
      <th>ip_addr</th>
      <th>order_amount</th>
      <th>customer_id</th>
      <th>email_by_customer_id</th>
      <th>ip_addr_by_customer_id</th>
      <th>num_email_by_customer_id</th>
      <th>num_ip_addr_by_customer_id</th>
      <th>...</th>
      <th>same_email_by_customer_id</th>
      <th>same_ip_addr_by_customer_id</th>
      <th>known_email_by_customer_id</th>
      <th>known_ip_addr_by_customer_id</th>
      <th>order_amount_mean_by_customer_id</th>
      <th>order_amount_std_by_customer_id</th>
      <th>order_amount_min_by_customer_id</th>
      <th>order_amount_max_by_customer_id</th>
      <th>order_amount_sum_by_customer_id</th>
      <th>order_amount_by_customer_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>43055b88-30c4-4224-8697-ab322ca0d642</td>
      <td>2020-05-07 10:53:21+00:00</td>
      <td>c981fe20491503912ff664740a3f97e2d77ddd6e</td>
      <td>d957cc5adeeb4f39b29dd3cb84204f52177069e7</td>
      <td>972.352792</td>
      <td>00100242-b7fb-478f-ac50-16774cef232c</td>
      <td>["c981fe20491503912ff664740a3f97e2d77ddd6e", "...</td>
      <td>["d957cc5adeeb4f39b29dd3cb84204f52177069e7", "...</td>
      <td>1</td>
      <td>2</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>522.676999</td>
      <td>318.449988</td>
      <td>89.088352</td>
      <td>972.352792</td>
      <td>5226.769995</td>
      <td>[567.6496593625884, 89.08835212177269, 216.277...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3e40614a-cc08-4b2b-b974-765b1acfb9f7</td>
      <td>2020-06-21 13:09:18+00:00</td>
      <td>c981fe20491503912ff664740a3f97e2d77ddd6e</td>
      <td>d957cc5adeeb4f39b29dd3cb84204f52177069e7</td>
      <td>866.082201</td>
      <td>00100242-b7fb-478f-ac50-16774cef232c</td>
      <td>["c981fe20491503912ff664740a3f97e2d77ddd6e", "...</td>
      <td>["d957cc5adeeb4f39b29dd3cb84204f52177069e7", "...</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>613.614071</td>
      <td>239.666862</td>
      <td>310.594941</td>
      <td>943.812111</td>
      <td>6136.140712</td>
      <td>[943.8121110109099, 928.4246988157718, 310.594...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>52baa413-4853-45b2-8944-a32a3f1a7908</td>
      <td>2020-04-07 08:51:12+00:00</td>
      <td>c981fe20491503912ff664740a3f97e2d77ddd6e</td>
      <td>d957cc5adeeb4f39b29dd3cb84204f52177069e7</td>
      <td>233.483800</td>
      <td>00100242-b7fb-478f-ac50-16774cef232c</td>
      <td>["c981fe20491503912ff664740a3f97e2d77ddd6e", "...</td>
      <td>["d957cc5adeeb4f39b29dd3cb84204f52177069e7", "...</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>421.409455</td>
      <td>210.804553</td>
      <td>89.088352</td>
      <td>834.000464</td>
      <td>4214.094551</td>
      <td>[470.18093506588053, 573.7203277223783, 250.74...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>092cb774-2412-4bfb-bd61-0e55aebad1e0</td>
      <td>2020-05-29 12:42:14+00:00</td>
      <td>c981fe20491503912ff664740a3f97e2d77ddd6e</td>
      <td>d957cc5adeeb4f39b29dd3cb84204f52177069e7</td>
      <td>310.594941</td>
      <td>00100242-b7fb-478f-ac50-16774cef232c</td>
      <td>["c981fe20491503912ff664740a3f97e2d77ddd6e", "...</td>
      <td>["d957cc5adeeb4f39b29dd3cb84204f52177069e7", "...</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>707.163611</td>
      <td>272.294281</td>
      <td>135.586162</td>
      <td>972.352792</td>
      <td>7071.636113</td>
      <td>[748.7377739689492, 842.2944822793909, 972.352...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>a23c2b25-b815-47b9-9c27-195502c64e37</td>
      <td>2019-08-22 11:21:32+00:00</td>
      <td>c981fe20491503912ff664740a3f97e2d77ddd6e</td>
      <td>dc7bb980ca2c5c80451196fb93f44f0e83e8f81f</td>
      <td>598.571076</td>
      <td>00100242-b7fb-478f-ac50-16774cef232c</td>
      <td>["c981fe20491503912ff664740a3f97e2d77ddd6e", "...</td>
      <td>["d957cc5adeeb4f39b29dd3cb84204f52177069e7", "...</td>
      <td>1</td>
      <td>4</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>635.571967</td>
      <td>275.372603</td>
      <td>79.062306</td>
      <td>959.817775</td>
      <td>6355.719671</td>
      <td>[537.3812355224538, 334.91419993288116, 79.062...</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 22 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order_id</th>
      <th>order_date</th>
      <th>customer_id</th>
      <th>ip_addr</th>
      <th>order_amount</th>
      <th>email</th>
      <th>customer_id_by_email</th>
      <th>num_customer_id_by_email</th>
      <th>last_customer_id_by_email</th>
      <th>same_customer_id_by_email</th>
      <th>known_customer_id_by_email</th>
      <th>order_amount_mean_by_email</th>
      <th>order_amount_std_by_email</th>
      <th>order_amount_min_by_email</th>
      <th>order_amount_max_by_email</th>
      <th>order_amount_sum_by_email</th>
      <th>order_amount_by_email</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>f0d63eec-8589-46fc-98aa-e9d49fead2eb</td>
      <td>2020-05-27 17:28:52+00:00</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>7a4be0ba1a02ae4a27cf152848be77b35181b2ad</td>
      <td>66.255347</td>
      <td>00038ba252faef9a24b098ca6594c202b468e6db</td>
      <td>["bce8b787-e1b5-405c-9b3e-06fc91b31c36", "bce8...</td>
      <td>1</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>1</td>
      <td>1</td>
      <td>492.376981</td>
      <td>321.362474</td>
      <td>50.196317</td>
      <td>974.606197</td>
      <td>4923.769808</td>
      <td>[865.5761207952322, 529.3101147270868, 769.143...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>f8310a94-64aa-4938-89c8-574ca8d08e78</td>
      <td>2020-06-30 22:54:51+00:00</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>dcf438634cfd4b0ad0d72cee70e638cea9fd9070</td>
      <td>716.340468</td>
      <td>00038ba252faef9a24b098ca6594c202b468e6db</td>
      <td>["bce8b787-e1b5-405c-9b3e-06fc91b31c36", "bce8...</td>
      <td>1</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>1</td>
      <td>1</td>
      <td>557.434306</td>
      <td>251.412444</td>
      <td>66.255347</td>
      <td>913.562427</td>
      <td>5574.343056</td>
      <td>[66.25534670339583, 245.04497173829088, 487.11...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>936cd7af-f2b7-4dd0-a10d-50f55951b7b5</td>
      <td>2020-03-09 20:38:20+00:00</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>7a4be0ba1a02ae4a27cf152848be77b35181b2ad</td>
      <td>912.128646</td>
      <td>00038ba252faef9a24b098ca6594c202b468e6db</td>
      <td>["bce8b787-e1b5-405c-9b3e-06fc91b31c36", "bce8...</td>
      <td>1</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>1</td>
      <td>1</td>
      <td>482.109044</td>
      <td>274.778605</td>
      <td>72.114069</td>
      <td>912.128646</td>
      <td>4821.090443</td>
      <td>[555.6353073554191, 143.60326579705617, 72.114...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>07ed5409-b5ff-4a88-87b4-c6bd9ed29e1a</td>
      <td>2020-04-11 09:36:36+00:00</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>7a4be0ba1a02ae4a27cf152848be77b35181b2ad</td>
      <td>451.643311</td>
      <td>00038ba252faef9a24b098ca6594c202b468e6db</td>
      <td>["bce8b787-e1b5-405c-9b3e-06fc91b31c36", "bce8...</td>
      <td>1</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>1</td>
      <td>1</td>
      <td>574.573381</td>
      <td>237.089251</td>
      <td>68.484679</td>
      <td>912.128646</td>
      <td>5745.733814</td>
      <td>[439.3317003697285, 544.3782438612366, 649.361...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>48fc743c-60af-42b0-8658-2fe82e6a8c08</td>
      <td>2020-02-01 13:43:27+00:00</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>7a4be0ba1a02ae4a27cf152848be77b35181b2ad</td>
      <td>72.114069</td>
      <td>00038ba252faef9a24b098ca6594c202b468e6db</td>
      <td>["bce8b787-e1b5-405c-9b3e-06fc91b31c36", "bce8...</td>
      <td>1</td>
      <td>bce8b787-e1b5-405c-9b3e-06fc91b31c36</td>
      <td>1</td>
      <td>1</td>
      <td>368.225832</td>
      <td>244.774665</td>
      <td>72.114069</td>
      <td>963.814082</td>
      <td>3682.258322</td>
      <td>[392.77047614406723, 420.9638784860715, 254.77...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

