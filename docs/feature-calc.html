---

title: Feature calculation


keywords: fastai
sidebar: home_sidebar

summary: "This module calculates features/aggregations that could be useful to detect fraudulent transactions. Results are saved into 2 parquet datasets for features email and customer_id features. These features are calculated:"
description: "This module calculates features/aggregations that could be useful to detect fraudulent transactions. Results are saved into 2 parquet datasets for features email and customer_id features. These features are calculated:"
nb_path: "03_feature-calc.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_feature-calc.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="calculate" class="doc_header"><code>calculate</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/feature_calc.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>calculate</code>(<strong><code>df</code></strong>, <strong><code>count_cols</code></strong>, <strong><code>stat_cols</code></strong>, <strong><code>by</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="count_distinct_values" class="doc_header"><code>count_distinct_values</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/feature_calc.py#L34" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>count_distinct_values</code>(<strong><code>df</code></strong>, <strong><code>cols</code></strong>, <strong><code>by</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="num_stats" class="doc_header"><code>num_stats</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/feature_calc.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>num_stats</code>(<strong><code>df</code></strong>, <strong><code>cols</code></strong>, <strong><code>by</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run" class="doc_header"><code>run</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/feature_calc.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run</code>(<strong><code>job</code></strong>:<a href="/fraud_poc/jobs.html#PreprocessingJob"><code>PreprocessingJob</code></a>, <strong><code>context</code></strong>:<code>EventContext</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-from-notebook">Test from notebook<a class="anchor-link" href="#Test-from-notebook"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">hopeit.testing.apps</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">execute_event</span>

<span class="n">app_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;config/training-pipeline.json&#39;</span><span class="p">)</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">PreprocessingJob</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;./data/raw&#39;</span><span class="p">,</span> <span class="n">partitioned</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="s1">&#39;./data/partitioned/customer_id/&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;./data/partitioned/email&#39;</span>
<span class="p">})</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">execute_event</span><span class="p">(</span><span class="n">app_config</span><span class="p">,</span> <span class="s1">&#39;data.feature-calc&#39;</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
<span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2021-05-18 20:27:03,391 | INFO | fraud-poc training data.feature-calc ALT00617 75592 | Calculating features on customer_id... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2021-05-18T20:27:02.159375+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
2021-05-18 20:27:04,473 | INFO | fraud-poc training data.feature-calc ALT00617 75592 | Saved ./data/features/customer_id/. | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2021-05-18T20:27:02.159375+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
2021-05-18 20:27:04,473 | INFO | fraud-poc training data.feature-calc ALT00617 75592 | Calculating features on email... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2021-05-18T20:27:02.159375+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
2021-05-18 20:27:05,344 | INFO | fraud-poc training data.feature-calc ALT00617 75592 | Saved ./data/features/email/. | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2021-05-18T20:27:02.159375+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>FeatureCalcJob(sources={&#39;customer_id&#39;: &#39;./data/partitioned/customer_id/&#39;, &#39;email&#39;: &#39;./data/partitioned/email&#39;}, features={&#39;customer_id&#39;: &#39;./data/features/customer_id/&#39;, &#39;email&#39;: &#39;./data/features/email/&#39;})</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order_id</th>
      <th>order_date</th>
      <th>email</th>
      <th>ip_addr</th>
      <th>order_amount</th>
      <th>customer_id</th>
      <th>email_by_customer_id</th>
      <th>ip_addr_by_customer_id</th>
      <th>num_email_by_customer_id</th>
      <th>num_ip_addr_by_customer_id</th>
      <th>...</th>
      <th>same_email_by_customer_id</th>
      <th>same_ip_addr_by_customer_id</th>
      <th>known_email_by_customer_id</th>
      <th>known_ip_addr_by_customer_id</th>
      <th>order_amount_mean_by_customer_id</th>
      <th>order_amount_std_by_customer_id</th>
      <th>order_amount_min_by_customer_id</th>
      <th>order_amount_max_by_customer_id</th>
      <th>order_amount_sum_by_customer_id</th>
      <th>order_amount_by_customer_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7beaa6ea-27ea-4082-a0ca-e216b93521a1</td>
      <td>2021-05-07 22:49:55+00:00</td>
      <td>af9ec8893d8c212276b9916b2599efe88510207d</td>
      <td>e18142d2fcd6626e86d40573fd268c2f5f449a60</td>
      <td>301.888156</td>
      <td>00c00d42-6923-4297-87c4-107bc70035be</td>
      <td>["af9ec8893d8c212276b9916b2599efe88510207d"]</td>
      <td>["e18142d2fcd6626e86d40573fd268c2f5f449a60"]</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>301.888156</td>
      <td>0.000000</td>
      <td>301.888156</td>
      <td>301.888156</td>
      <td>301.888156</td>
      <td>[301.8881562196214]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4069005c-02d0-4f41-b065-ad4b82412f20</td>
      <td>2021-05-07 05:29:05+00:00</td>
      <td>30650ad8775163a27cc73b642d3de1f46a337aaa</td>
      <td>110fef07ad03b67a2f30fcebd6ab190bc2d11252</td>
      <td>86.057737</td>
      <td>048e9104-8369-407b-a0a1-fb06c06760c1</td>
      <td>["30650ad8775163a27cc73b642d3de1f46a337aaa"]</td>
      <td>["110fef07ad03b67a2f30fcebd6ab190bc2d11252"]</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>86.057737</td>
      <td>0.000000</td>
      <td>86.057737</td>
      <td>86.057737</td>
      <td>86.057737</td>
      <td>[86.05773660199678]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3e5bb9cc-bdef-4693-8870-49967d510ae3</td>
      <td>2021-05-03 10:08:39+00:00</td>
      <td>79cdeec4056ed0714127c4c255d9dafa334ee2a7</td>
      <td>ee714f6b18d2b01e2d632f1299d8cb7618099070</td>
      <td>945.678360</td>
      <td>09da86be-63c3-4265-a799-8fe5efaf270c</td>
      <td>["79cdeec4056ed0714127c4c255d9dafa334ee2a7"]</td>
      <td>["ee714f6b18d2b01e2d632f1299d8cb7618099070"]</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>945.678360</td>
      <td>0.000000</td>
      <td>945.678360</td>
      <td>945.678360</td>
      <td>945.678360</td>
      <td>[945.678359760513]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9cc8c9aa-e342-4e7a-8269-4ebb7bc0d208</td>
      <td>2021-05-15 04:11:54+00:00</td>
      <td>79cdeec4056ed0714127c4c255d9dafa334ee2a7</td>
      <td>ee714f6b18d2b01e2d632f1299d8cb7618099070</td>
      <td>955.929156</td>
      <td>09da86be-63c3-4265-a799-8fe5efaf270c</td>
      <td>["79cdeec4056ed0714127c4c255d9dafa334ee2a7", "...</td>
      <td>["ee714f6b18d2b01e2d632f1299d8cb7618099070", "...</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>950.803758</td>
      <td>5.125398</td>
      <td>945.678360</td>
      <td>955.929156</td>
      <td>1901.607516</td>
      <td>[945.678359760513, 955.9291560497809]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5b3900c1-e2ca-4226-81ee-0aa47d825005</td>
      <td>2021-05-07 09:52:48+00:00</td>
      <td>86665ef2c644c5f6a50e7702a7d5b0b88ee3c68b</td>
      <td>8a799f9e07fa26a47e84fd8f64ea20ae5601a489</td>
      <td>525.625661</td>
      <td>0c5e0c2c-fb79-4a60-94c4-501bf2d07278</td>
      <td>["86665ef2c644c5f6a50e7702a7d5b0b88ee3c68b", "...</td>
      <td>["8a799f9e07fa26a47e84fd8f64ea20ae5601a489", "...</td>
      <td>5</td>
      <td>5</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>680.036988</td>
      <td>236.531382</td>
      <td>336.752082</td>
      <td>997.119448</td>
      <td>4760.258919</td>
      <td>[336.7520815122097, 821.1451274507584, 922.876...</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 22 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order_id</th>
      <th>order_date</th>
      <th>customer_id</th>
      <th>ip_addr</th>
      <th>order_amount</th>
      <th>email</th>
      <th>customer_id_by_email</th>
      <th>num_customer_id_by_email</th>
      <th>last_customer_id_by_email</th>
      <th>same_customer_id_by_email</th>
      <th>known_customer_id_by_email</th>
      <th>order_amount_mean_by_email</th>
      <th>order_amount_std_by_email</th>
      <th>order_amount_min_by_email</th>
      <th>order_amount_max_by_email</th>
      <th>order_amount_sum_by_email</th>
      <th>order_amount_by_email</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>564ca53c-92ae-44e9-b550-857bc3f32299</td>
      <td>2021-05-07 16:47:55+00:00</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>2061d686466fd7bdd0c4ff12c0c0431adfb4b584</td>
      <td>296.665980</td>
      <td>06b27c6a29714eead08e96789b9ed37c6b33c67b</td>
      <td>["1161afda-4b7f-498b-b07c-a19c8ff25383", "1161...</td>
      <td>1</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>1</td>
      <td>1</td>
      <td>620.601978</td>
      <td>323.935998</td>
      <td>296.665980</td>
      <td>944.537976</td>
      <td>1241.203956</td>
      <td>[944.5379757024328, 296.6659799710525]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>78210c4e-1997-477f-92f7-c78da8f6e2b0</td>
      <td>2021-05-12 00:37:48+00:00</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>e1bf51a3b72ef02c554f338b28ea67a61f2effa9</td>
      <td>675.094589</td>
      <td>06b27c6a29714eead08e96789b9ed37c6b33c67b</td>
      <td>["1161afda-4b7f-498b-b07c-a19c8ff25383", "1161...</td>
      <td>1</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>1</td>
      <td>1</td>
      <td>638.766181</td>
      <td>265.737145</td>
      <td>296.665980</td>
      <td>944.537976</td>
      <td>1916.298544</td>
      <td>[944.5379757024328, 296.6659799710525, 675.094...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>bab6d5be-14fe-4705-9765-ad5fc5a14b82</td>
      <td>2021-05-15 01:52:11+00:00</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>e1bf51a3b72ef02c554f338b28ea67a61f2effa9</td>
      <td>860.661434</td>
      <td>06b27c6a29714eead08e96789b9ed37c6b33c67b</td>
      <td>["1161afda-4b7f-498b-b07c-a19c8ff25383", "1161...</td>
      <td>1</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>1</td>
      <td>1</td>
      <td>582.538511</td>
      <td>315.696452</td>
      <td>135.732576</td>
      <td>944.537976</td>
      <td>2912.692555</td>
      <td>[944.5379757024328, 296.6659799710525, 675.094...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>d12ec21f-c115-45c4-b5c9-904578faa733</td>
      <td>2021-05-01 23:42:34+00:00</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>e1bf51a3b72ef02c554f338b28ea67a61f2effa9</td>
      <td>944.537976</td>
      <td>06b27c6a29714eead08e96789b9ed37c6b33c67b</td>
      <td>["1161afda-4b7f-498b-b07c-a19c8ff25383"]</td>
      <td>1</td>
      <td></td>
      <td>0</td>
      <td>0</td>
      <td>944.537976</td>
      <td>0.000000</td>
      <td>944.537976</td>
      <td>944.537976</td>
      <td>944.537976</td>
      <td>[944.5379757024328]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>c1adb330-64c2-40c1-931a-86ba8dde545d</td>
      <td>2021-05-14 06:56:31+00:00</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>e1bf51a3b72ef02c554f338b28ea67a61f2effa9</td>
      <td>135.732576</td>
      <td>06b27c6a29714eead08e96789b9ed37c6b33c67b</td>
      <td>["1161afda-4b7f-498b-b07c-a19c8ff25383", "1161...</td>
      <td>1</td>
      <td>1161afda-4b7f-498b-b07c-a19c8ff25383</td>
      <td>1</td>
      <td>1</td>
      <td>513.007780</td>
      <td>316.871739</td>
      <td>135.732576</td>
      <td>944.537976</td>
      <td>2052.031121</td>
      <td>[944.5379757024328, 296.6659799710525, 675.094...</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

