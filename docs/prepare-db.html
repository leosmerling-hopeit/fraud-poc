---

title: Title

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 07_prepare-db.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Prepare-Database">Prepare Database<a class="anchor-link" href="#Prepare-Database"> </a></h3><blockquote><p>This step uses calculated features, and extract most recent values for each customer_id and email in the dataset to initialize a real time database (Redis) that can be used by live fraud prediction service.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="update_database" class="doc_header"><code>update_database</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/data/prepare_db.py#L56" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>update_database</code>(<strong><code>job</code></strong>:<a href="/fraud_poc/jobs#FeatureCalcJob"><code>FeatureCalcJob</code></a>, <strong><code>context</code></strong>:<code>EventContext</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-from-notebook">Test from notebook<a class="anchor-link" href="#Test-from-notebook"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">hopeit.testing.apps</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">execute_event</span>

<span class="n">app_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;config/training-pipeline.json&#39;</span><span class="p">)</span>
<span class="n">job</span> <span class="o">=</span> <span class="n">FeatureCalcJob</span><span class="p">(</span><span class="n">sources</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="s1">&#39;./data/partitioned/customer_id/&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;./data/partitioned/email&#39;</span><span class="p">},</span> 
                     <span class="n">features</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="s1">&#39;./data/features/customer_id/&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;./data/features/email/&#39;</span><span class="p">})</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">execute_event</span><span class="p">(</span><span class="n">app_config</span><span class="p">,</span> <span class="s1">&#39;data.prepare-db&#39;</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
<span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-07-08 14:47:30,084 | INFO | fraud-poc 0.0.1-training data.prepare-db leos13 27299 | Preparing to save to database localhost:6379... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T14:47:28.743022+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
2020-07-08 14:47:30,085 | INFO | fraud-poc 0.0.1-training data.prepare-db leos13 27299 | Saving latest state for customer_id features... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T14:47:28.743022+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
2020-07-08 14:47:30,087 | INFO | fraud-poc 0.0.1-training data.prepare-db leos13 27299 | Saving latest state for email features... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T14:47:28.743022+00:00 | stream.name= | stream.msg_id= | stream.consumer_group=
distributed.nanny - WARNING - Worker process still alive after 3 seconds, killing
distributed.nanny - WARNING - Worker process still alive after 3 seconds, killing
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>PrepareDbJob(features={&#39;customer_id&#39;: &#39;./data/features/customer_id/&#39;, &#39;email&#39;: &#39;./data/features/email/&#39;}, db=&#39;localhost:6379&#39;, saved={&#39;customer_id&#39;: 64, &#39;email&#39;: 100})</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#customer id aggregation</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;d555b585-5511-4a16-9f22-819834110239&#39;</span><span class="p">)</span>
<span class="n">deserialize</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Serialization</span><span class="o">.</span><span class="n">PICKLE4</span><span class="p">,</span> <span class="n">Compression</span><span class="o">.</span><span class="n">LZ4</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-8-d14ad5c5c568&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> db <span class="ansi-blue-fg">=</span> redis<span class="ansi-blue-fg">.</span>Redis<span class="ansi-blue-fg">(</span>host<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&#39;localhost&#39;</span><span class="ansi-blue-fg">,</span> port<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">6379</span><span class="ansi-blue-fg">,</span> db<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> item <span class="ansi-blue-fg">=</span> db<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;d555b585-5511-4a16-9f22-819834110239&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 4</span><span class="ansi-red-fg"> </span>deserialize<span class="ansi-blue-fg">(</span>item<span class="ansi-blue-fg">,</span> Serialization<span class="ansi-blue-fg">.</span>PICKLE4<span class="ansi-blue-fg">,</span> Compression<span class="ansi-blue-fg">.</span>LZ4<span class="ansi-blue-fg">,</span> dict<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/opt/dev/anaconda3/envs/fraud-poc/lib/python3.7/site-packages/hopeit/server/serialization.py</span> in <span class="ansi-cyan-fg">deserialize</span><span class="ansi-blue-fg">(data, serialization, compression, datatype)</span>
<span class="ansi-green-intense-fg ansi-bold">     57</span>                 datatype: Type[EventPayloadType]) -&gt; EventPayload:
<span class="ansi-green-intense-fg ansi-bold">     58</span>     algos <span class="ansi-blue-fg">=</span> _SERDESER<span class="ansi-blue-fg">[</span>serialization<span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">---&gt; 59</span><span class="ansi-red-fg">     </span>decomp <span class="ansi-blue-fg">=</span> decompress<span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">,</span> compression<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     60</span>     <span class="ansi-green-fg">return</span> algos<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>decomp<span class="ansi-blue-fg">,</span> datatype<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/opt/dev/anaconda3/envs/fraud-poc/lib/python3.7/site-packages/hopeit/server/compression.py</span> in <span class="ansi-cyan-fg">decompress</span><span class="ansi-blue-fg">(data, compression)</span>
<span class="ansi-green-intense-fg ansi-bold">     98</span> 
<span class="ansi-green-intense-fg ansi-bold">     99</span> <span class="ansi-green-fg">def</span> decompress<span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">:</span> bytes<span class="ansi-blue-fg">,</span> compression<span class="ansi-blue-fg">:</span> Compression<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> bytes<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 100</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> _DECOMPRESS<span class="ansi-blue-fg">[</span>compression<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/opt/dev/anaconda3/envs/fraud-poc/lib/python3.7/site-packages/hopeit/server/compression.py</span> in <span class="ansi-cyan-fg">_decompress_lz4</span><span class="ansi-blue-fg">(data)</span>
<span class="ansi-green-intense-fg ansi-bold">     29</span> 
<span class="ansi-green-intense-fg ansi-bold">     30</span> <span class="ansi-green-fg">def</span> _decompress_lz4<span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">:</span> bytes<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> bytes<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 31</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> lz4<span class="ansi-blue-fg">.</span>frame<span class="ansi-blue-fg">.</span>decompress<span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     32</span> 
<span class="ansi-green-intense-fg ansi-bold">     33</span> 

<span class="ansi-red-fg">TypeError</span>: a bytes-like object is required, not &#39;NoneType&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#email aggregations</span>
<span class="n">item</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;1f5d34b02ef1975d5a82dcfe2e53fad6182e118c&#39;</span><span class="p">)</span>
<span class="n">deserialize</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Serialization</span><span class="o">.</span><span class="n">PICKLE4</span><span class="p">,</span> <span class="n">Compression</span><span class="o">.</span><span class="n">LZ4</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

