---

title: Title

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 08_predict.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Live-Predict">Live Predict<a class="anchor-link" href="#Live-Predict"> </a></h3><blockquote><p>This module implements the POST endpoint for the Fraud Prediction Service. It can be invoked with an Order payload,
then this steps will retrieve concurrently features calculated on customer_id and email, update the features using received order information on the fly, and predict is_fraud label using trained XGBoost model.</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="OrderInfo" class="doc_header"><code>class</code> <code>OrderInfo</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/live/predict.py#L30" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>OrderInfo</code>(<strong><code>order_id</code></strong>:<code>str</code>, <strong><code>customer_id</code></strong>:<code>str</code>, <strong><code>order_date</code></strong>:<code>datetime</code>, <strong><code>email</code></strong>:<code>str</code>, <strong><code>ip_addr</code></strong>:<code>str</code>, <strong><code>order_amount</code></strong>:<code>float</code>, <strong><code>location_lat</code></strong>:<code>float</code>, <strong><code>location_long</code></strong>:<code>float</code>) :: <code>JsonSchemaMixin</code></p>
</blockquote>
<p>OrderInfo(order_id: str, customer_id: str, order_date: datetime.datetime, email: str, ip_addr: str, order_amount: float, location_lat: float, location_long: float)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="__init_event__" class="doc_header"><code>__init_event__</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/live/predict.py#L70" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>__init_event__</code>(<strong><code>context</code></strong>:<code>EventContext</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="lookup_features" class="doc_header"><code>lookup_features</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/live/predict.py#L91" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>lookup_features</code>(<strong><code>order</code></strong>:<a href="/fraud_poc/08-predict#OrderInfo"><code>OrderInfo</code></a>, <strong><code>context</code></strong>:<code>EventContext</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="predict" class="doc_header"><code>predict</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/live/predict.py#L143" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>predict</code>(<strong><code>data</code></strong>:<code>dict</code>, <strong><code>context</code></strong>:<code>EventContext</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="__postprocess__" class="doc_header"><code>__postprocess__</code><a href="https://github.com/leosmerling/fraud_poc/tree/master/fraud_poc/live/predict.py#L152" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>__postprocess__</code>(<strong><code>payload</code></strong>:<code>Optional</code>[<code>dict</code>], <strong><code>context</code></strong>:<code>EventContext</code>, <strong><code>response</code></strong>:<code>PostprocessHook</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-from-notebook">Test from notebook<a class="anchor-link" href="#Test-from-notebook"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">hopeit.testing.apps</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">execute_event</span>
<span class="kn">from</span> <span class="nn">fraud_poc.live.predict</span> <span class="kn">import</span> <span class="n">OrderInfo</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">uuid</span>
 
<span class="k">def</span> <span class="nf">new_key</span><span class="p">():</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

<span class="n">app_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s1">&#39;config/fraud-service.json&#39;</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">OrderInfo</span><span class="p">(</span>
    <span class="n">order_id</span><span class="o">=</span><span class="n">new_key</span><span class="p">(),</span>
    <span class="n">customer_id</span><span class="o">=</span><span class="s1">&#39;d555b585-5511-4a16-9f22-819834110239&#39;</span><span class="p">,</span>
    <span class="n">order_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
    <span class="n">email</span><span class="o">=</span><span class="s1">&#39;1f5d34b02ef1975d5a82dcfe2e53fad6182e118c&#39;</span><span class="p">,</span>
    <span class="n">ip_addr</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">order_amount</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span>
    <span class="n">location_lat</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">location_long</span><span class="o">=</span><span class="mf">0.0</span>
<span class="p">)</span> 

<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">execute_event</span><span class="p">(</span><span class="n">app_config</span><span class="p">,</span> <span class="s1">&#39;live.predict&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-07-08 15:28:02,221 | INFO | fraud-poc 0.0.1-service live.predict leos13 29709 | __init_event__ module=fraud_poc.live.predict... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T15:28:02.221506+00:00
2020-07-08 15:28:02,225 | INFO | fraud-poc 0.0.1-service live.predict leos13 29709 | Loading model for prediction from ./data/model/xgb/latest-ok.pkl... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T15:28:02.221506+00:00
2020-07-08 15:28:02,228 | INFO | fraud-poc 0.0.1-service live.predict leos13 29709 | Connecting to database redis://localhost:6379... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T15:28:02.221506+00:00
2020-07-08 15:28:02,232 | INFO | fraud-poc 0.0.1-service live.predict leos13 29709 | Looking up features in database... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T15:28:02.221506+00:00
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">payload</span> <span class="o">=</span> <span class="n">OrderInfo</span><span class="p">(</span>
    <span class="n">order_id</span><span class="o">=</span><span class="n">new_key</span><span class="p">(),</span>
    <span class="n">customer_id</span><span class="o">=</span><span class="s1">&#39;002d6c90-2680-494a-b65e-c969c48277c8&#39;</span><span class="p">,</span>
    <span class="n">order_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">),</span>
    <span class="n">email</span><span class="o">=</span><span class="s1">&#39;1f5d34b02ef1975d5a82dcfe2e53fad6182e118c&#39;</span><span class="p">,</span>
    <span class="n">ip_addr</span><span class="o">=</span><span class="s1">&#39;c7ee6b54b39b1b5edefa3aa85d24665ed8feadd5&#39;</span><span class="p">,</span>
    <span class="n">order_amount</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">location_lat</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">location_long</span><span class="o">=</span><span class="mf">0.0</span>
<span class="p">)</span> 

<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">execute_event</span><span class="p">(</span><span class="n">app_config</span><span class="p">,</span> <span class="s1">&#39;live.predict&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">result</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-07-08 11:38:45,990 | INFO | fraud-poc 0.0.1-service live.predict leo-legion 38272 | __init_event__ module=fraud_poc.live.predict... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T11:38:45.990505+00:00
2020-07-08 11:38:45,991 | INFO | fraud-poc 0.0.1-service live.predict leo-legion 38272 | Looking up features in database... | track.operation_id=test_operation_id | track.request_id=test_request_id | track.request_ts=2020-07-08T11:38:45.990505+00:00
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;order_id&#39;: &#39;29b1eb9a-17ed-4ea5-96b7-70b5c274dae5&#39;,
 &#39;order_date&#39;: &#39;2020-07-08T11:38:45.990197+00:00&#39;,
 &#39;customer_id&#39;: &#39;002d6c90-2680-494a-b65e-c969c48277c8&#39;,
 &#39;ip_addr&#39;: &#39;c7ee6b54b39b1b5edefa3aa85d24665ed8feadd5&#39;,
 &#39;order_amount&#39;: 10.0,
 &#39;email&#39;: &#39;1f5d34b02ef1975d5a82dcfe2e53fad6182e118c&#39;,
 &#39;customer_id_by_email&#39;: [&#39;002d6c90-2680-494a-b65e-c969c48277c8&#39;,
  &#39;d555b585-5511-4a16-9f22-819834110239&#39;],
 &#39;num_customer_id_by_email&#39;: 2,
 &#39;last_customer_id_by_email&#39;: &#39;d555b585-5511-4a16-9f22-819834110239&#39;,
 &#39;same_customer_id_by_email&#39;: 1,
 &#39;known_customer_id_by_email&#39;: 1,
 &#39;order_amount_mean_by_email&#39;: 429.30120590151927,
 &#39;order_amount_std_by_email&#39;: 286.4232086984392,
 &#39;order_amount_min_by_email&#39;: 10.0,
 &#39;order_amount_max_by_email&#39;: 879.7319538388477,
 &#39;order_amount_sum_by_email&#39;: 4293.012059015193,
 &#39;order_amount_by_email&#39;: [387.7647884248259,
  202.94798232836487,
  10.0,
  13.426760485169664,
  591.5459546297528,
  879.7319538388477,
  722.9025680336106,
  627.8375917324881,
  249.78620396645113,
  607.0682555756823],
 &#39;key&#39;: &#39;002d6c90-2680-494a-b65e-c969c48277c8&#39;,
 &#39;email_by_customer_id&#39;: [&#39;afe4b272a5def9d9b3cd9d8ac9b6136bbe90ffe9&#39;,
  &#39;1f5d34b02ef1975d5a82dcfe2e53fad6182e118c&#39;],
 &#39;ip_addr_by_customer_id&#39;: [&#39;c7ee6b54b39b1b5edefa3aa85d24665ed8feadd5&#39;],
 &#39;num_email_by_customer_id&#39;: 2,
 &#39;num_ip_addr_by_customer_id&#39;: 1,
 &#39;last_email_by_customer_id&#39;: &#39;afe4b272a5def9d9b3cd9d8ac9b6136bbe90ffe9&#39;,
 &#39;last_ip_addr_by_customer_id&#39;: &#39;c7ee6b54b39b1b5edefa3aa85d24665ed8feadd5&#39;,
 &#39;same_email_by_customer_id&#39;: 1,
 &#39;same_ip_addr_by_customer_id&#39;: 1,
 &#39;known_email_by_customer_id&#39;: 1,
 &#39;known_ip_addr_by_customer_id&#39;: 1,
 &#39;order_amount_mean_by_customer_id&#39;: 512.1876094673013,
 &#39;order_amount_std_by_customer_id&#39;: 302.04578020233225,
 &#39;order_amount_min_by_customer_id&#39;: 10.0,
 &#39;order_amount_max_by_customer_id&#39;: 895.8665915672377,
 &#39;order_amount_sum_by_customer_id&#39;: 5121.876094673013,
 &#39;order_amount_by_customer_id&#39;: [551.3028970809393,
  840.1112472933949,
  10.0,
  459.04884566221347,
  620.4744338380846,
  780.6965636312258,
  145.4531898362139,
  693.7183138797553,
  125.20401188394759,
  895.8665915672377],
 &#39;location_lat&#39;: 0.0,
 &#39;location_long&#39;: 0.0,
 &#39;is_fraud&#39;: 0.4534066617488861}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

